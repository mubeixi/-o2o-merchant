tinymce.PluginManager.add('lplink', function (editor, url) {
  var pluginName = '绑定小程序链接'

  window.lplink = {} // 扔外部公共变量，也可以扔一个自定义的位置
  var openDialog = function () {
    return editor.windowManager.open({
      title: '请输入小程序路由',
      body: {
        type: 'panel',
        items: [
          {
            type: 'input',
            name: 'title',
            label: '请输入小程序包含参数的地址，仅支持当前系统绑定的小程序使用'
          },
          {
            type: 'input',
            name: 'label',
            label: '显示名称'
          },
        ]
      },
      buttons: [
        {
          type: 'cancel',
          text: '取消'
        },
        {
          type: 'submit',
          text: '确认',
          primary: true
        }
      ],
      onSubmit: function (api) {
        var data = api.getData();
        if(!data.label)data.label = '小程序链接'
        if(data.title && data.label){
          // 将输入框内容插入到内容区光标位置
          editor.insertContent(`<p><span class="link-min-ele" data-type="link-mini" data-url="${data.title}">${data.label}</span></p>`);
          api.close();
        }else{
          alert('两项内容必填')
        }


      }
    });
  };

  editor.ui.registry.getAll().icons.lplink || editor.ui.registry.addIcon('lplink', '<svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M402.2 734.6c-71.9 0-130.4-54.1-130.4-121 0-20.8 6-41.2 16.9-59.5 16.4-26.8 42.7-46.6 74.4-56 8.4-2.5 14.9-3.5 20.8-3.5 13.9 0 24.8 10.9 24.8 24.8s-10.9 24.8-24.8 24.8c-1 0-3 0-5.5 1-21.3 6-38.2 18.4-47.6 34.7-6.5 10.4-9.4 21.8-9.4 33.7 0 39.2 36.2 71.4 80.4 71.4 15.4 0 30.3-4 43.7-11.4 23.3-13.4 37.2-35.7 37.2-60V405.7c0-42.2 23.3-80.8 62-102.7 20.8-11.9 44.1-17.9 68-17.9 71.9 0 130.4 54.1 130.4 121 0 20.8-6 41.2-16.9 59.5-16.4 26.8-42.7 46.6-74.4 56-8.9 2.5-14.9 3.5-20.8 3.5-13.9 0-24.8-10.9-24.8-24.8s10.9-24.8 24.8-24.8c1 0 3 0 5.5-1 21.3-6.4 38.2-18.9 47.6-34.7 6.4-10.4 9.4-21.8 9.4-33.7 0-39.2-36.2-71.4-80.8-71.4-15.4 0-30.3 4-43.7 11.4-23.3 13.4-37.2 35.7-37.2 60v207.3c0 42.2-23.3 80.9-62 102.7-20.5 12.5-43.8 18.5-67.6 18.5z m504.4-223.2c0-219.2-177.6-396.8-396.8-396.8S113 292.1 113 511.4s177.6 396.8 396.8 396.8 396.8-177.6 396.8-396.8z m49.6 0c0 246.5-199.9 446.4-446.4 446.4-246.5 0-446.4-199.9-446.4-446.4C63.4 264.9 263.3 65 509.8 65c246.5 0 446.4 199.9 446.4 446.4z m0 0"></path></svg>')

  editor.ui.registry.addButton('lplink', {
    icon: 'lplink',
    tooltip: pluginName,
    onAction: function () {
      openDialog()
    }
  })
  editor.ui.registry.addMenuItem('axupimgs', {
    icon: 'lplink',
    text: '绑定小程序链接...',
    onAction: function () {
      openDialog()
    }
  })
  return {
    getMetadata: function () {
      return {
        name: pluginName,
        url: 'http://tinymce.ax-z.cn/more-plugins/lplink.php'
      }
    }
  }
})


tinymce.PluginManager.add('funimgs', function (editor, url) {
	var pluginName = '多图片上传'
	window.funimgs = {} // 扔外部公共变量，也可以扔一个自定义的位置

	var baseURL = tinymce.baseURL
	var iframe1 = baseURL + '/plugins/axupimgs/upfiles.html'
	funimgs.images_upload_handler = editor.getParam('images_upload_handler', undefined, 'function')
	funimgs.images_upload_base_path = editor.getParam('images_upload_base_path', '', 'string')
	funimgs.axupimgs_filetype = editor.getParam('axupimgs_filetype', '.png,.gif,.jpg,.jpeg', 'string')
	funimgs.res = []
	var openDialog = function () {
		return editor.windowManager.openUrl({
			title: pluginName,
			size: 'large',
			url: iframe1,
			buttons: [
				{
					type: 'cancel',
					text: 'Close'
				},
				{
					type: 'custom',
					text: 'Save',
					name: 'save',
					primary: true
				}
			],
			onAction: function (api, details) {
				switch (details.name) {
					case 'save':
						var html = ''
						var imgs = funimgs.res
						var len = imgs.length
						for (let i = 0; i < len; i++) {
							if (imgs[i].url) {
								html += '<img src="' + imgs[i].url + '" />'
							}
						}
						editor.insertContent(html)
						funimgs.res = []
						api.close()
						break
					default:
						break
				}
			}
		})
	}






	//console.log(window.CKFinder)



	editor.ui.registry.getAll().icons.funimgs || editor.ui.registry.addIcon('funimgs', '<svg width="24" height="24"><path d="M5 15.7l3.3-3.2c.3-.3.7-.3 1 0L12 15l4.1-4c.3-.4.8-.4 1 0l2 1.9V5H5v10.7zM5 18V19h3l2.8-2.9-2-2L5 17.9zm14-3l-2.5-2.4-6.4 6.5H19v-4zM4 3h16c.6 0 1 .4 1 1v16c0 .6-.4 1-1 1H4a1 1 0 01-1-1V4c0-.6.4-1 1-1zm6 8a2 2 0 100-4 2 2 0 000 4z" fill-rule="nonzero"></path></svg>')


	const opt = {}
	const options = Object.assign({limit:10,type:'img'},opt);

	const callFn = {
		up:(url)=>{

			// insertImages( editor, [url] );
			// editor.editing.view.focus();
		},
		choose:(urls)=>{
			console.log(urls)
			var html = ''

			var len = urls.length
			for (let i = 0; i < len; i++) {
				if (urls[i]) {
					html += '<img src="' + urls[i] + '" />'
				}
			}
			editor.insertContent(html)
			// insertImages( editor, urls );
			// editor.editing.view.focus();
		},
		chooseMedia:(urls)=>{
			var html = ''
			var len = urls.length
			for (let i = 0; i < len; i++) {
				if (urls[i]) {
					var medieHtmlTmpl = `<video poster="" controls="controls" width="300" height="150"><source src="${urls[i]}" type="video/mp4" /></video>`
					html += medieHtmlTmpl
				}
			}
			editor.insertContent(html)

			// insertMediaFunc(editor, urls)
			// editor.editing.view.focus();
		}
	}


	editor.ui.registry.addButton('funimgs', {
		icon: 'funimgs',
		tooltip: pluginName,
		onAction: function () {
			// openDialog()
			window.FUNFinder.open({editor,options,callFn});
		}
	})
	editor.ui.registry.addMenuItem('funimgs', {
		icon: 'funimgs',
		text: '图片批量上传...',
		onAction: function () {
			// openDialog()
			window.FUNFinder.open({editor,options,callFn});
		}
	})
	return {
		getMetadata: function () {
			return {
				name: pluginName,
				url: 'http://tinymce.ax-z.cn/more-plugins/funimgs.php'
			}
		}
	}
})
